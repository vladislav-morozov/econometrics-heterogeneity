--- 
description: "Learn how to nonparametrically identify quantile treatment effects (QTEs) under unconfoundedness. Conditional + unconditional quantiles (Lecture Notes)"

open-graph:
    description: "Learn how to nonparametrically identify quantile treatment effects (QTEs) under unconfoundedness. Conditional + unconditional quantiles (Lecture Notes)"
---
 


# Nonparametric Identification of Quantile Treatment Effects under Unconfoundedness {#sec-qte-id-conf}

::: {.callout-note appearance="simple" icon=false}

## Summary and Learning Outcomes

This section  shows how to identify quantile treatment effects under conditional unconfoundedness.

By the end of this section, you should be able to:

- Use conditioning arguments to identify conditional and unconditional QTEs.
- Derive an inverse probability weighted representation for unconditional quantiles of potential outcomes. 

:::
    
 


## Focus: Quantile Treatment Effects

Having established identification for distributional treatment effects (DTEs), we now turn to the question of quantile treatment effects (QTEs). Our arguments in this section are broadly similar to those for DTEs, but present some quantile-specific challenges.

As in the previous section, we maintain the (conditional) unconfoundedness assumption from @eq-qte-unconf:

$$
 \curl{Y_i^x}_x \independent X_i|W_i.
$$ 

As noted in section [-@sec-qte-intro], we focus on the following parameters:


1. QTE  conditional on $W_i=w$ (@eq-qte-dfn-cond):
$$
\begin{align}
	QTE(x_1, x_2, \tau|w) & = Q_{Y^{x_2}|W}(\tau|w) - Q_{Y^{x_1}|W}(\tau|w).
\end{align}
$$
2. Unconditional QTE (@eq-qte-dfn-uncond):
$$
\begin{aligned}
	QTE(x_1, x_2, \tau ) &  =Q_{Y^{x_2}}(\tau) - 	Q_{Y^{x_1}}(\tau) .
\end{aligned}
$$
3. QTE  conditional on $X_i=x_3$ (@eq-qte-dfn-cond-treat):
$$
\begin{align}
	QTE(x_1, x_2, \tau|x_3) &  =Q_{Y^{x_2}|X}(\tau|x_3) - 	Q_{Y^{x_1}|X}(\tau|x_3) .
\end{align}
$$

Of these, we show a detailed identification result for the first two, while the latter conditional QTE can be identified using a combination of previous arguments. As before, it is sufficient to identify the quantile of $Y^x_i$, a task to which we now turn.
 
## Quantile Function Conditional on $W_i$

We again begin with the conditional quantiles of $Y^x_i$ given $W_i=w$, which is the most straightforward quantile to identify.

Like in the previous section, we assume that that for all $x$ the conditional CDF of $Y^x_i$ given $W_i=w$ is continuous and strictly increasing. Under these assumptions the conditional quantile $Q_{Y^x|W}(\tau|x)$ uniquely satisfies the following moment condition:

$$
\E\left[ \I\curl{ Y^x_i \leq Q_{Y^x|W}(\tau|w) } |W_i=w\right] =  \tau.
$$

We again aim to connect to write the above moment only in terms of $(Y_i, W_i, X_i)$ and the unknown target parameter $Q_{Y^x|W}(\tau|w)$. 

The first step is use the unconfoundedness assumption ([-@eq-qte-unconf]) to condition on $X_i=x$:
$$
\begin{aligned}
& \E\left[ \I\curl{ Y^x_i \leq Q_{Y^x|W}(\tau|w) } |W_i=w\right] \\
& =  \E\left[ \I\curl{ Y^x_i \leq Q_{Y^x|W}(\tau|w) } |X_i=x, W_i=w\right].
\end{aligned}
$$

Since $Y_i=Y^x_i$ under $\curl{X_i=x}$, we can replace $Y^x_i$ with $Y_i$:
$$
\begin{aligned}
&
\E\left[ \I\curl{ Y^x_i \leq Q_{Y^x|W}(\tau|w) } |X_i=x, W_i=w\right] \\
& = \E\left[ \I\curl{ Y_i \leq Q_{Y^x|W}(\tau|w) } |X_i=x, W_i=w\right] .
\end{aligned}
$$
We conclude that $Q_{Y^x|W}(\tau|w)$ must satisfy the moment condition 
$$
\tau = \E\left[ \I\curl{ Y_i \leq Q_{Y^x|W}(\tau|w) } |X_i=x, W_i=w\right].
$$
Here we again observe that the CDF of $Y_i$ given $W_i=w$ and $X_i=x$ is exactly the CDF of $Y^x_i$ given $W_i=w$, and hence strictly increasing and continuous. Let $Q_{Y|X, W}(\tau|x, w)$ be the $\tau$th quantile of $Y_i$ given $\curl{X_i=x, W_i=w}$. By continuity and monotonicity, $Q_{Y|X, W}(\tau|x, w)$ also uniquely satisfies the above moment condition. We conclude the following identification result:
$$
    Q_{Y^x|W}(\tau|w) = Q_{Y|X, W}(\tau|x, w).
$$ {#eq-qte-unconf-cond-w-quant}
In other words, the conditional quantile of potential outcome given covariates is equal to the conditional quantile of the observed outcomes given both covariates and the treatment. This result is a direct mirror of the CDF identification result (@eq-qte-dte-cond-id).
 
 

## Unconditional Quantile Function


The argument for unconditional quantile $Q_{Y^x}(\tau)$ is more delicate. In contrast to the CDF,  we cannot integrate @eq-qte-unconf-cond-w-quant with respect to the marginal distribution of $W_i$ (see @wrn-qte-intro-cond). Instead, identifying $Q_{Y^x}(\tau)$ involves using the conditioning trick showcased for the unconditional CDF in the last session.
 
As before, we start with the moment condition satisfied by the quantile of interest:
$$
\tau = P(Y^x_i\leq Q_{Y^x}(\tau) ).
$$

Like for the unconditional CDF, we use a conditioning trick to be able to apply unconfoundedness ([-@eq-qte-unconf]). We first iterate expectations with respect to $W_i$:

$$
\begin{aligned}
	\tau & = P(Y^x_i\leq Q_{Y^x}(\tau) ) \\
    & =  \E\left[ \I\curl{Y^x_i\leq Q_{Y^x}(\tau)  }\right]\\
    & =  \E\left[ \E\left[ \I\curl{Y^x_i\leq  Q_{Y^x}(\tau)  }|W_i \right]  \right] .
\end{aligned}
$$
We can now apply unconfoundedness inside the conditional expectation to link the moment condition to the observed outcome $Y_i$:
$$
\begin{aligned}
    & \E\left[\E\left[ \I\curl{Y^x_i\leq  Q_{Y^x}(\tau)  }|W_i \right]  \right] \\
    & =   \E\left[ \E\left[\I\curl{Y^x_i\leq Q_{Y^x}(\tau)  }| X_i=x, W_i\right]\right]  \\
	& = \E\left[ \E\left[\I\curl{Y_i\leq Q_{Y^x}(\tau)  }| X_i=x, W_i\right]\right].
\end{aligned}
$$
In principle, we now have obtained a moment condition that characterizes the quantile of interest:
$$
\tau = \E\left[ \E\left[\I\curl{Y_i\leq Q_{Y^x}(\tau)  }| X_i=x, W_i\right]\right].
$$

However, this condition is impractical: it involves an iterated expectation, and the parameter of interest is inside that conditional expectation.

Instead, we now develop a more practical characterization where conditioning is limited to propensity scores. To start, we observe that under the event $\curl{X_i=x}$ it holds that $\I\curl{X_i=x}$ is equal to 1. We can then multiply by $\I\curl{X_i=x}$(=1) under the conditional expectation:
$$
    \begin{aligned}
        &  \E\left[ \E\left[\I\curl{Y_i\leq Q_{Y^x}(\tau)  }| X_i=x, W_i\right]\right] \\
        & =  \E\left[ \E\left[\I\curl{X_i=x}\I\curl{Y\leq Q_{Y^x}(\tau) }|X_i=x, W_i\right]\right]
    \end{aligned}
$$ {#eq-qte-uncond-q-interm}

To proceed, we use the following version of the law of total expectations: 

::: {.callout-note appearance="simple"}

If $V, Z$ are random variables and $T$ is a 0/1 random variable, then
$$
\begin{aligned}
 		\E[Z|V]  & =  P(T=1|V) \E[Z|V, T=1] \\
        & \quad   + (1-P(T=1|V)) \E[Z|V, T=0].
\end{aligned}
$$ {#eq-qte-tot-exp}
:::

To apply the above law, we take $T = \I\curl{X_i=x}$ and  $Z = T\I\curl{Y_i\leq Q_{Y^x}(\tau)}$.  By construction, if $T=0$, then $Z=0$, and so the second term in @eq-qte-tot-exp is zero, and hence it holds that
$$
 	\begin{aligned}
 & 		\E\left[\I\curl{X_i=x}\I\curl{Y_i\leq Q_{Y^x}(\tau) }|X_i=x, W_i\right] 
 \\ 
 & = \dfrac{1}{P\left(X_i=x|W_i\right)} \E[\I\curl{X_i=x} \I\curl{Y_i\leq  Q_{Y^x}(\tau) }|W_i].
 	\end{aligned}
$$

We can now insert this characterization back into @eq-qte-uncond-q-interm, and finish the argument as follows:
$$
 \begin{aligned}
  &  \E\left[ \E\left[\I\curl{X_i=x}\I\curl{Y_i\leq Q_{Y^x}(\tau) }|X_i=x, W_i\right]\right]\\
 	& = \E\left[ \dfrac{1}{P\left(X_i=x|W_i\right)} \E[\curl{X_i=x} \I\curl{Y_i\leq  Q_{Y^x}(\tau) }|W_i] \right]\\
 	& =  \E\left[\E\left[  \dfrac{\I\curl{X_i=x}}{P\left(X_i=x|W_i\right)}  \I\curl{Y_i\leq  Q_{Y^x}(\tau) }|W_i\right] \right] \\
 	& = \E\left[  \dfrac{\I\curl{X_i=x} }{P\left(X_i=x|W_i\right)}\I\curl{Y_i\leq Q_{Y^x}(\tau) }\right].
 \end{aligned}
$$
Here we have again used the defining property of conditional expectations, this time to get rid of the internal conditional expectation. 


In summary, we have shown that the unconditional quantile of interest  $Q_{Y^x}(\tau)$ satisfies the following moment condition:
$$
 	 \E\left[  \dfrac{\I\curl{X_i=x} }{P\left(X_i=x|W_i\right)}\I\curl{Y_i\leq Q_{Y^x}(\tau) }\right] = \tau.
$$
This argument is originally due to @Firpo2007EfficientSemiparametricEstimation.


Intuitively, this moment conditions shows that $Q_{Y^x}(\tau)$ is the $\tau$th quantile of a suitably reweighted distribution of the observed outcome. Weighting is done by the inverse of the propensity scores $P(X_i=x|W_i)$, and hence the above result is an instance of identification using inverse probability weighting. 

As a final observation, we note that it is also possible to obtain a somewhat similar IPW expression for $F_{Y^d}(y)$ by proceeding as with $Q_{Y^d}$ starting from the iterated expectation. See @Donald2014EstimationInferenceDistribution.
 
 
---

#### Next Section {.unnumbered}

In the next section, we move towards estimation of these parameters by briefly introducing quantile regression.