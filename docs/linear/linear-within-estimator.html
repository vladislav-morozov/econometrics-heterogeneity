<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Learn why the within (fixed effects) estimator works only under narrow conditions with heterogeneous coefficients. Lecture notes.">

<title>3&nbsp; Within (Fixed Effects) Estimator and Heterogeneous Coefficients – Econometrics with Unobserved Heterogeneity</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../linear/linear-dynamic-panel-iv.html" rel="next">
<link href="../linear/linear-introduction.html" rel="prev">
<link href="../themes/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-bc185b5c5bdbcb35c2eb49d8a876ef70.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-42b6b074c9a9b52e1c5988a113e9f873.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-5563d1243c07a021538a2a9893f7bae8.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
 

<!-- This is what works with Quarto and MathJax 3+ -->

<script>

  MathJax = {

    tex: {

      tags: 'ams',  // should be 'ams', 'none', or 'all'

      macros: {

        vect: ["\\mathbf{#1}", 1],

        mat: ["\\mathbf{#1}", 1], 



        bA: "\\boldsymbol{A}",

        bB: "\\boldsymbol{B}",

        bC: "\\boldsymbol{C}",

        bD: "\\boldsymbol{D}",

        bE: "\\boldsymbol{E}",

        bF: "\\boldsymbol{F}",

        bG: "\\boldsymbol{G}",

        bH: "\\boldsymbol{H}",

        bI: "\\boldsymbol{I}",

        bJ: "\\boldsymbol{J}",

        bK: "\\boldsymbol{K}",

        bL: "\\boldsymbol{L}",

        bM: "\\boldsymbol{M}",

        bN: "\\boldsymbol{N}",

        bP: "\\boldsymbol{P}",

        bQ: "\\boldsymbol{Q}",

        bR: "\\boldsymbol{R}",

        bS: "\\boldsymbol{S}",

        bT: "\\boldsymbol{T}",

        bU: "\\boldsymbol{U}",

        bV: "\\boldsymbol{V}",

        bW: "\\boldsymbol{W}",

        bX: "\\boldsymbol{X}",

        bY: "\\boldsymbol{Y}",

        bZ: "\\boldsymbol{Z}",

        ba: "\\boldsymbol{a}",

        bb: "\\boldsymbol{b}",

        bc: "\\boldsymbol{c}",

        bd: "\\boldsymbol{d}",

        be: "\\boldsymbol{e}",

        bg: "\\boldsymbol{g}",

        bh: "\\boldsymbol{h}",

        bi: "\\boldsymbol{\\imath}",

        bm: "\\boldsymbol{m}",

        bp: "\\boldsymbol{p}",

        bq: "\\boldsymbol{q}",

        br: "\\boldsymbol{r}",

        bs: "\\boldsymbol{s}",

        bt: "\\boldsymbol{t}",

        bu: "\\boldsymbol{u}",

        bv: "\\boldsymbol{v}",

        bw: "\\boldsymbol{w}",

        bx: "\\boldsymbol{x}",

        by: "\\boldsymbol{y}",

        bz: "\\boldsymbol{z}",



        Acal: "\\mathcal{A}",

        Bcal: "\\mathcal{B}",

        Ccal: "\\mathcal{C}",

        Dcal: "\\mathcal{D}",

        Ecal: "\\mathcal{E}",

        Fcal: "\\mathcal{F}",

        Gcal: "\\mathcal{G}",

        Hcal: "\\mathcal{H}",

        Ical: "\\mathcal{I}",

        Jcal: "\\mathcal{J}",

        Kcal: "\\mathcal{K}",

        Lcal: "\\mathcal{L}",

        Mcal: "\\mathcal{M}",

        Ncal: "\\mathcal{N}",

        Ocal: "\\mathcal{O}",

        Pcal: "\\mathcal{P}",

        Qcal: "\\mathcal{Q}",

        Rcal: "\\mathcal{R}",

        Scal: "\\mathcal{S}",

        Tcal: "\\mathcal{T}",

        Ucal: "\\mathcal{U}",

        Vcal: "\\mathcal{V}",

        Wcal: "\\mathcal{W}",

        Xcal: "\\mathcal{X}",

        Ycal: "\\mathcal{Y}",

        Zcal: "\\mathcal{Z}",



        A: "\\mathbb{A}",

        B: "\\mathbb{B}",

        C: "\\mathbb{C}",

        D: "\\mathbb{D}",

        E: "\\mathbb{E}",

        F: "\\mathbb{F}",

        G: "\\mathbb{G}",

        H: "\\mathbb{H}",

        I: "\\mathbb{I}",

        J: "\\mathbb{J}",

        K: "\\mathbb{K}",

        L: "\\mathbb{L}",

        M: "\\mathbb{M}",

        N: "\\mathbb{N}",

        O: "\\mathbb{O}",

        P: "\\mathbb{P}",

        Q: "\\mathbb{Q}",

        R: "\\mathbb{R}",

        S: "\\mathbb{S}",

        T: "\\mathbb{T}",

        U: "\\mathbb{U}",

        V: "\\mathbb{V}",

        W: "\\mathbb{W}",

        X: "\\mathbb{X}",

        Y: "\\mathbb{Y}",

        Z: "\\mathbb{Z}",



        bAlpha: "\\boldsymbol{\\Alpha}",

        bBeta: "\\boldsymbol{\\beta}",

        bDelta: "\\boldsymbol{\\delta}",

        bEta: "\\boldsymbol{\\eta}",

        bGamma: "\\boldsymbol{\\Gamma}",

        bLambda: "\\boldsymbol{\\Lambda}",

        bOmega: "\\boldsymbol{\\Omega}",

        bPhi: "\\boldsymbol{\\Phi}",

        bPi: "\\boldsymbol{\\Pi}",

        bPsi: "\\boldsymbol{\\Psi}",

        bSigma: "\\boldsymbol{\\Sigma}",

        bTau: "\\boldsymbol{\\tau}",

        bXi: "\\boldsymbol{\\Xi}",

        bbeta: "\\boldsymbol{\\beta}",

        bdelta: "\\boldsymbol{\\delta}",

        blambda: "\\boldsymbol{\\lambda}",

        bmu: "\\boldsymbol{\\mu}",

        bphi: "\\boldsymbol{\\phi}",

        bpi: "\\boldsymbol{\\pi}",

        bpsi: "\\boldsymbol{\\psi}",

        brho: "\\boldsymbol{\\rho}",

        bsigma: "\\boldsymbol{\\sigma}",

        btau: "\\boldsymbol{\\tau}",

        bxi: "\\boldsymbol{\\xi}",

        bEta: "\\boldsymbol{\\eta}",

        bPhi: "\\boldsymbol{\\Phi}",

        bPi: "\\boldsymbol{\\Pi}",

        bPsi: "\\boldsymbol{\\Psi}",

        bXi: "\\boldsymbol{\\Xi}",

        blambda: "\\boldsymbol{\\lambda}",

        bmu: "\\boldsymbol{\\mu}",

        bphi: "\\boldsymbol{\\phi}",

        bpi: "\\boldsymbol{\\pi}",

        bpsi: "\\boldsymbol{\\psi}",

        brho: "\\boldsymbol{\\rho}",

        bsigma: "\\boldsymbol{\\sigma}",

                   

        curl: ["\\left\\lbrace#1\\right\\rbrace", 1],

        floor: ["\\left\\lfloor#1\\right\\rfloor", 1],

        ceil: ["\\left\\lceil#1\\right\\rceil", 1],

        abs: ["\\left\\lvert#1\\right\\rvert", 1],

        norm: ["\\left\\lVert#1\\right\\rVert", 1],



        independent: "\\mathrel{\\perp\\!\\!\\perp}",



        var: "\\mathrm{var}",

        diag: "\\mathrm{diag}",

        rank: "\\mathrm{rank}",

        vecc: "\\mathrm{vec}",

      }

    }

  };

</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<meta property="og:title" content="3&nbsp; Within (Fixed Effects) Estimator and Heterogeneous Coefficients – Econometrics with Unobserved Heterogeneity">
<meta property="og:description" content="Learn why the within (fixed effects) estimator works only under narrow conditions with heterogeneous coefficients. Lecture notes.">
<meta property="og:image" content="https://vladislav-morozov.github.io/econometrics-heterogeneity/figures/ols_heterogeneity.svg">
<meta property="og:site_name" content="Econometrics with Unobserved Heterogeneity">
</head>

<body class="nav-sidebar floating quarto-dark"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = true;
    const darkModeDefault = authorPrefersDark;
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../linear/linear-introduction.html">Linear Models</a></li><li class="breadcrumb-item"><a href="../linear/linear-within-estimator.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Within (Fixed Effects) Estimator and Heterogeneous Coefficients</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Econometrics with Unobserved Heterogeneity</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://vladislav-morozov.github.io/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-person-arms-up"></i></a>
    <a href="https://www.linkedin.com/in/vladislavvmorozov/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-linkedin"></i></a>
    <a href="https://github.com/vladislav-morozov/econometrics-heterogeneity/tree/main/src/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course Information</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction: Causal Inference with Unobserved Heterogeneity</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Linear Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../linear/linear-introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Intro: Linear Models with Heterogeneous Coefficients</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../linear/linear-within-estimator.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Within (Fixed Effects) Estimator and Heterogeneous Coefficients</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../linear/linear-dynamic-panel-iv.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Interlude: Standard Dynamic Panel Estimators</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../linear/linear-dynamic-panel-heterogeneity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Heterogeneous Coefficient Dynamic Panels and Instrumental Variable Estimators</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../linear/linear-mean-group.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Mean Group: Robust Estimator for Average Coefficients</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../linear/linear-coefficient-variance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Variance of Heterogeneous Coefficients</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../linear/linear-chf.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Interlude: Characteristic Functions and Deconvolution</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../linear/linear-distribution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Distribution of Heterogeneous Coefficients</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../linear/linear-conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Conclusion: Linear Models</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Nonparametrics and Heterogeneity</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nonparametric/nonparametric-introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Introduction to Nonparametric Models with Unobserved Heterogeneity</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nonparametric/nonparametric-heterogeneity-bias.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Average Effects and Heterogeneity Bias</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nonparametric/nonparametric-average-identification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Nonparametric Identification of Average Effects</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nonparametric/nonparametric-average-estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Nonparametric Estimation of Average Effects</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nonparametric/nonparametric-location-scale.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Relaxing Stationarity with Nonparametric Time Effects</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nonparametric/nonparametric-cre.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Beyond Stayers Using Index Restrictions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nonparametric/nonparametric-variance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Variance of Marginal Effects</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Quantile and Distributional Treatment Effects</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qte-dte/qte-dte-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Defining Quantile and Distributional Treatment Effects</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references/references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">3.1</span> Introduction</a>
  <ul class="collapse">
  <li><a href="#focus-workhorse-estimators-under-heterogeneity" id="toc-focus-workhorse-estimators-under-heterogeneity" class="nav-link" data-scroll-target="#focus-workhorse-estimators-under-heterogeneity"><span class="header-section-number">3.1.1</span> Focus: Workhorse Estimators under Heterogeneity</a></li>
  <li><a href="#this-section-static-model-and-fixed-t" id="toc-this-section-static-model-and-fixed-t" class="nav-link" data-scroll-target="#this-section-static-model-and-fixed-t"><span class="header-section-number">3.1.2</span> This Section: Static Model and Fixed <span class="math inline">\(T\)</span></a></li>
  </ul></li>
  <li><a href="#recall-within-estimator-in-the-random-intercept-model" id="toc-recall-within-estimator-in-the-random-intercept-model" class="nav-link" data-scroll-target="#recall-within-estimator-in-the-random-intercept-model"><span class="header-section-number">3.2</span> Recall: Within Estimator in the Random Intercept Model</a>
  <ul class="collapse">
  <li><a href="#construction" id="toc-construction" class="nav-link" data-scroll-target="#construction"><span class="header-section-number">3.2.1</span> Construction</a></li>
  <li><a href="#properties" id="toc-properties" class="nav-link" data-scroll-target="#properties"><span class="header-section-number">3.2.2</span> Properties</a></li>
  </ul></li>
  <li><a href="#adding-heterogeneous-coefficients" id="toc-adding-heterogeneous-coefficients" class="nav-link" data-scroll-target="#adding-heterogeneous-coefficients"><span class="header-section-number">3.3</span> Adding Heterogeneous Coefficients</a>
  <ul class="collapse">
  <li><a href="#sampling-error-form" id="toc-sampling-error-form" class="nav-link" data-scroll-target="#sampling-error-form"><span class="header-section-number">3.3.1</span> Sampling Error Form</a></li>
  <li><a href="#conditions-for-estimating-average-coefficients" id="toc-conditions-for-estimating-average-coefficients" class="nav-link" data-scroll-target="#conditions-for-estimating-average-coefficients"><span class="header-section-number">3.3.2</span> Conditions for Estimating Average Coefficients</a></li>
  <li><a href="#intuition" id="toc-intuition" class="nav-link" data-scroll-target="#intuition"><span class="header-section-number">3.3.3</span> Intuition</a></li>
  <li><a href="#why-panel-data-is-useful" id="toc-why-panel-data-is-useful" class="nav-link" data-scroll-target="#why-panel-data-is-useful"><span class="header-section-number">3.3.4</span> Why Panel Data is Useful</a></li>
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example"><span class="header-section-number">3.3.5</span> Example</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/vladislav-morozov/econometrics-heterogeneity/edit/main/src/linear/linear-within-estimator.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/vladislav-morozov/econometrics-heterogeneity/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../linear/linear-introduction.html">Linear Models</a></li><li class="breadcrumb-item"><a href="../linear/linear-within-estimator.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Within (Fixed Effects) Estimator and Heterogeneous Coefficients</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-linear-within" class="quarto-section-identifier"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Within (Fixed Effects) Estimator and Heterogeneous Coefficients</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Summary and Learning Outcomes
</div>
</div>
<div class="callout-body-container callout-body">
<p>This section shows that the within (fixed effects) estimator consistently estimates average coefficients only under narrow assumptions.</p>
<p>By the end of this section, you should</p>
<ul>
<li>Refresh your knowledge of within (fixed effects) estimation.</li>
<li>Learn when the within estimator gives consistent estimates of average coefficients in heterogeneous models.</li>
<li>See the first example of heterogeneity bias in this course.</li>
</ul>
</div>
</div>
<section id="introduction" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">3.1</span> Introduction</h2>
<p>As noted in the previous section, in this block we focus our attention on the linear panel data model with unit-specific heterogeneous coefficients (<a href="linear-introduction.html#eq-lecture_model" class="quarto-xref">Equation&nbsp;<span>2.7</span></a>): <span id="eq-within-lecture-model"><span class="math display">\[
Y_{it}^{\bx} = \bbeta_i'\bx + U_{it}.
\tag{3.1}\]</span></span></p>
<p>Our first key parameter of interest is the <em>average coefficient vector <span class="math inline">\(\E[\bbeta_i]\)</span></em>— the linear model analog to the average treatment effect.</p>
<section id="focus-workhorse-estimators-under-heterogeneity" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="focus-workhorse-estimators-under-heterogeneity"><span class="header-section-number">3.1.1</span> Focus: Workhorse Estimators under Heterogeneity</h3>
<p>Can existing workhorse estimators for linear panel data models — the within (fixed effects) and dynamic panel IV estimators — correctly estimate <span class="math inline">\(\E[\bbeta_i]\)</span>? Of course, those methods were developed in the context of the simpler random intercept model (<a href="linear-introduction.html#eq-random_intercept" class="quarto-xref"><span>2.8</span></a>) <span id="eq-within-lecture-random-intercept"><span class="math display">\[
Y_{it}^{\bx} = A_i + \bbeta'\bx + U_{it}.
\tag{3.2}\]</span></span> However, if they can also handle the more general <a href="#eq-within-lecture-model" class="quarto-xref">Equation&nbsp;<span>3.1</span></a>, then all the better for us — we do not need to develop any new methods.</p>
<p>Unfortunately, such standard estimators usually fail when coefficients vary across units, as we demonstrate in this and the next few sections. This failure holds both for static and the dynamic formulations of <a href="#eq-within-lecture-model" class="quarto-xref">Equation&nbsp;<span>3.1</span></a>.</p>
</section>
<section id="this-section-static-model-and-fixed-t" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="this-section-static-model-and-fixed-t"><span class="header-section-number">3.1.2</span> This Section: Static Model and Fixed <span class="math inline">\(T\)</span></h3>
<p>In this section, we consider the static case and the associated workhorse estimator — the within (fixed effects) estimator. By “static”, we mean that the model does not include lagged dependent variables as regressors. In addition, we assume strict exogeneity <span class="math display">\[
\E[\bU_i|\bX_i]=0,
\]</span> where <span class="math inline">\(\bU_i = (U_{i1}, \dots, U_{it})\)</span> and <span class="math inline">\(\bX_i = (\bX_{i1}', \dots, \bX_{iT}')'\)</span>.</p>
<p>Throughout, we assume that the number <span class="math inline">\(N\)</span> of cross-sectional units is potentially large, while the number <span class="math inline">\(T\)</span> of data points per unit is fixed. This setup is more reflective of typical micropanels.</p>
</section>
</section>
<section id="recall-within-estimator-in-the-random-intercept-model" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="recall-within-estimator-in-the-random-intercept-model"><span class="header-section-number">3.2</span> Recall: Within Estimator in the Random Intercept Model</h2>
<p>To begin, we briefly go through the construction and the properties of the within estimator under the random intercept model (<a href="#eq-within-lecture-random-intercept" class="quarto-xref"><span>3.2</span></a>).</p>
<section id="construction" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="construction"><span class="header-section-number">3.2.1</span> Construction</h3>
<p>Within (“fixed effects”) estimation of the random intercept model has two steps:</p>
<ol type="1">
<li>Apply the within transformation to each unit.</li>
<li>Apply OLS to the resulting pooled data.</li>
</ol>
<section id="step-1-within-transformation" class="level4" data-number="3.2.1.1">
<h4 data-number="3.2.1.1" class="anchored" data-anchor-id="step-1-within-transformation"><span class="header-section-number">3.2.1.1</span> Step 1: Within Transformation</h4>
<p>To perform the within transformation, we first average the equations for unit <span class="math inline">\(i\)</span> across <span class="math inline">\(t\)</span>. Label the average of <span class="math inline">\(Y_{it}\)</span> across <span class="math inline">\(t\)</span> for unit <span class="math inline">\(i\)</span> as</p>
<p><span class="math display">\[
Y_{i\cdot} = \frac{1}{T} \sum_{t=1}^{T} Y_{it}.
\]</span></p>
<p>The averaged realized outcome <span class="math inline">\(Y_{i\cdot}\)</span> satisfies the averaged equation</p>
<p><span class="math display">\[
Y_{i\cdot} = A_i + \bbeta' \bX_{i\cdot} + U_{i\cdot},
\]</span> where the averaged variables <span class="math inline">\(\bX_{i\cdot}\)</span> and <span class="math inline">\(U_{i\cdot}\)</span> are defined analogously to <span class="math inline">\(Y_{i\cdot}\)</span>.</p>
<p>Define the within-transformed variables by subtracting this averaged equation from the original equation for each <span class="math inline">\(t\)</span>: <span class="math display">\[
\tilde{Y}_{it} = Y_{it} - Y_{i\cdot}.
\]</span></p>
<p>If <a href="#eq-within-lecture-random-intercept" class="quarto-xref">Equation&nbsp;<span>3.2</span></a> is true, the realized within transformed variables follow the within-transformed equation:</p>
<p><span id="eq-within_transformed"><span class="math display">\[
\tilde{Y}_{it} = \bbeta' \tilde{\bX}_{it} + \tilde{Y}_{it}.
\tag{3.3}\]</span></span></p>
<p>Under <a href="#eq-within-lecture-random-intercept" class="quarto-xref">Equation&nbsp;<span>3.2</span></a>, the within transformation eliminates the individual random intercepts <span class="math inline">\(A_i\)</span>. <a href="#eq-within_transformed" class="quarto-xref">Equation&nbsp;<span>3.3</span></a> now looks like a regular homogeneous regression.</p>
</section>
<section id="step-2-ols-on-the-within-transformed-equation" class="level4" data-number="3.2.1.2">
<h4 data-number="3.2.1.2" class="anchored" data-anchor-id="step-2-ols-on-the-within-transformed-equation"><span class="header-section-number">3.2.1.2</span> Step 2: OLS on the Within-Transformed Equation</h4>
<p>The within (fixed effects) estimator is obtained by simply pooling the data across <span class="math inline">\(i\)</span> and <span class="math inline">\(t\)</span> in <a href="#eq-within_transformed" class="quarto-xref">Equation&nbsp;<span>3.3</span></a> and applying OLS to it. Specifically, the estimator is given by</p>
<p><span id="eq-within_representation_random_intercept"><span class="math display">\[
\hat{\bbeta}^W = \left(\sum_{i=1}^{N} \tilde{\bX}_i' \tilde{\bX}_i \right)^{-1} \sum_{i=1}^{N} \tilde{\bX}_i \tilde{\bY}_i,
\tag{3.4}\]</span></span> where <span class="math inline">\(\bY_i = (Y_{i1}, \dots, Y_{iT})\)</span>.</p>
</section>
</section>
<section id="properties" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="properties"><span class="header-section-number">3.2.2</span> Properties</h3>
<p>The within estimator enjoys several desirable properties if the underlying causal model is actually given by the random intercept model (<a href="#eq-within-lecture-random-intercept" class="quarto-xref"><span>3.2</span></a>). Most of these properties can be derived from its sampling error representation <span id="eq-within-sampling-error-homogeneous"><span class="math display">\[
\hat{\bbeta}^W = \bbeta + \left(\sum_{i=1}^{N} \tilde{\bX}_i' \tilde{\bX}_i \right)^{-1} \sum_{i=1}^{N} \tilde{\bX}_i \tilde{\bU}_i.
\tag{3.5}\]</span></span></p>
<ul>
<li><p><span class="math inline">\(\hat{\bbeta}^W\)</span> is unbiased for <span class="math inline">\(\bbeta\)</span>. To show this, it is sufficient to notice that strict exogeneity of <span class="math inline">\(\bU_i\)</span> with respect to <span class="math inline">\(\bX_i\)</span> implies strict exogeneity of <span class="math inline">\(\tilde{\bU}_i\)</span> with respect to <span class="math inline">\(\tilde{\bX}_i\)</span>: <span class="math display">\[
\E[\tilde{\bU}_i|\tilde{\bX}_i] =
\E[\E[\tilde{\bU}_i|\bX_i]|\tilde{\bX}_i] = 0.
\]</span> It follows that the mean of the second term in <a href="#eq-within-sampling-error-homogeneous" class="quarto-xref">Equation&nbsp;<span>3.5</span></a> is 0, and so <span class="math display">\[
\E[\hat{\bbeta}^W] = \bbeta.
\]</span></p></li>
<li><p><span class="math inline">\(\hat{\bbeta}^W\)</span> is consistent for <span class="math inline">\(\bbeta\)</span> and asymptotically normal, provided a standard rank condition holds for <span class="math inline">\(\tilde{\bX}_i\)</span>: <span id="eq-within_asymptotic"><span class="math display">\[
\hat{\bbeta}^W \xrightarrow{p} \bbeta, \quad \sqrt{N}(\hat{\bbeta}^W - \bbeta) \Rightarrow N(0, \Sigma).  
\tag{3.6}\]</span></span></p></li>
</ul>
<p>Since <span class="math inline">\(\bbeta\)</span> is the average coefficient vector in this homogeneous model, we conclude that the within estimator consistently estimates average coefficients under the random intercept model (<a href="#eq-within-lecture-random-intercept" class="quarto-xref"><span>3.2</span></a>).</p>
</section>
</section>
<section id="adding-heterogeneous-coefficients" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="adding-heterogeneous-coefficients"><span class="header-section-number">3.3</span> Adding Heterogeneous Coefficients</h2>
<p>However, there is usually no theoretical reason for the slopes <span class="math inline">\(\bbeta\)</span> to be homogeneous. An assumption of slope homogeneity goes against acknowledging heterogeneity and including the random intercept terms <span class="math inline">\(A_i\)</span> in the first place. It is rather more realistic to consider the more general <a href="#eq-within-lecture-model" class="quarto-xref">Equation&nbsp;<span>3.1</span></a>. Accordingly, we now turn to studying the properties of <span class="math inline">\(\hat{\bbeta}^W\)</span> in this more realistic setting.</p>
<section id="sampling-error-form" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="sampling-error-form"><span class="header-section-number">3.3.1</span> Sampling Error Form</h3>
<p>Applying the within transformation to the heterogeneous <a href="#eq-within-lecture-model" class="quarto-xref">Equation&nbsp;<span>3.1</span></a> yields another version of the within-transformed equation:</p>
<p><span class="math display">\[
\tilde{Y}_{it} = \bbeta_i' \tilde{\bX}_{it} + \tilde{U}_{it}.
\]</span></p>
<p>Note that now the individual heterogeneity is not eliminated! The heterogeneous coefficients <span class="math inline">\(\bbeta_i\)</span> remain in the equation.</p>
<p>The within estimator on the above equation may then be represented as <span class="math display">\[
\begin{aligned}
\hat{\bbeta}^W  &amp; = \left(\sum_{i=1}^N \tilde{\bX}_i'\tilde{\bX}_i \right)^{-1} \sum_{i=1}^N \tilde{\bX}_i \tilde{\bY}_i \\
&amp; = \left(\sum_{i=1}^N \tilde{\bX}_i'\tilde{\bX}_i \right)^{-1} \sum_{i=1}^N \tilde{\bX}_i \tilde{\bX}_i\bbeta_i + \left(\sum_{i=1}^N \tilde{\bX}_i'\tilde{\bX}_i \right)^{-1} \sum_{i=1}^N \tilde{\bX}_i \tilde{\bU}_i.
\end{aligned}
\]</span> Note the difference of the sampling error representation with <a href="#eq-within-sampling-error-homogeneous" class="quarto-xref">Equation&nbsp;<span>3.5</span></a>. The first term is now a weighted average of the individual coefficients. The weights themselves depend on the second moments of the within-transformed explanatory variables, which may be viewed as a kind of variance weighting for units.</p>
<p>Does the within estimator target <span class="math inline">\(\E[\bbeta_i]\)</span>? To proceed, we decompose <span class="math inline">\(\bbeta_i\)</span> into a common mean component <span class="math inline">\(\E[\bbeta_i]\)</span> and an idiosyncratic deviation <span class="math inline">\(\bEta_i\)</span>: <span class="math display">\[
\bbeta_i = \E[\bbeta_i] + \bEta_i
\]</span></p>
<p>With this representation, we can further analyze the within estimator as <span class="math display">\[
\begin{aligned}
    \hat{\bbeta} &amp; = \E[\bbeta_i]  + \left( \dfrac{1}{N}\sum_{i=1}^N \tilde{\bX}_i'\tilde{\bX}_i \right)^{-1}  \dfrac{1}{N}\sum_{i=1}^N \tilde{\bX}_i \tilde{\bX}_i\bEta_i \\
    &amp;  \phantom{ = \E[\bbeta_i] } \hspace{1.3mm} + \left( \dfrac{1}{N}\sum_{i=1}^N  \tilde{\bX}_i'\tilde{\bX}_i \right)^{-1} \dfrac{1}{N}\sum_{i=1}^N \tilde{\bX}_i \tilde{\bU}_i\\
    &amp; \xrightarrow{p} \E[\bbeta_i]  + \left(\E\left[\tilde{\bX}_i'\tilde{\bX}_i \right] \right)^{-1} \E\left[\tilde{\bX}_i'\tilde{\bX}_i\bEta_i \right]  \\
  &amp;    \phantom{ \xrightarrow{p} \E[\bbeta_i] } \hspace{1.3mm} + \left(\E\left[\tilde{\bX}_i'\tilde{\bX}_i \right] \right)^{-1} \E\left[\tilde{\bX}_i'\tilde{\bU}_i \right]\\
    &amp; = \E[\bbeta_i] + \left(\E\left[\tilde{\bX}_i'\tilde{\bX}_i \right] \right)^{-1} \E\left[\tilde{\bX}_i'\tilde{\bX}_i\bEta_i \right],
\end{aligned}
\]</span> where we have assumed that a suitable law of large numbers applies as <span class="math inline">\(N\to\infty\)</span> and <span class="math inline">\(T\)</span> is fixed, and where <span class="math inline">\(\E\left[\tilde{\bX}_i'\tilde{\bU}_i \right]=0\)</span> as above.</p>
</section>
<section id="conditions-for-estimating-average-coefficients" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="conditions-for-estimating-average-coefficients"><span class="header-section-number">3.3.2</span> Conditions for Estimating Average Coefficients</h3>
<p>The above representation shows that the within estimator is not estimating <span class="math inline">\(\E[\bbeta_i]\)</span> unless the following orthogonality condition holds: <span id="eq-average_orthogonality_condition"><span class="math display">\[
    \E\left[\tilde{\bX}_i'\tilde{\bX}_i\bEta_i \right] =0.
\tag{3.7}\]</span></span> Even though <span class="math inline">\(\E[\bEta_i]=0\)</span>, the above condition does not necessarily hold if <span class="math inline">\(\bbeta_i\)</span> and <span class="math inline">\(\bX_i\)</span> are allowed to dependent.</p>
<p>If condition (<a href="#eq-average_orthogonality_condition" class="quarto-xref"><span>3.7</span></a>) holds, the within estimator is consistent for <span class="math inline">\(\E[\bbeta_i]\)</span> in the heterogeneous coefficient model (<a href="#eq-within-lecture-model" class="quarto-xref"><span>3.1</span></a>). If it fails, the estimator is biased. The difference between the estimand and <span class="math inline">\(\E[\bbeta_i]\)</span> is known as <em>heterogeneity bias</em> <span class="citation" data-cites="Campello2019">(see <a href="../references/references.html#ref-Campello2019" role="doc-biblioref">Campello, Galvao, and Juhl 2019</a> in the linear case)</span>.</p>
<p>This orthogonality condition (<a href="#eq-average_orthogonality_condition" class="quarto-xref"><span>3.7</span></a>) is a bit complicated to understand. A simpler sufficient condition is a mean independence on the coefficients given the within transformed covariates: <span id="eq-mean_independence_condition"><span class="math display">\[
\E[\boldsymbol{\eta}_i|\tilde{\bX}_i] = 0.  
\tag{3.8}\]</span></span> Under this condition <span class="math inline">\(\E[\tilde{\bX}_i'\tilde{\bX}_i\bEta_i] =0\)</span>, and thus the within estimator is consistent for <span class="math inline">\(\E[\bbeta_i]\)</span>. These conditions were proposed by <span class="citation" data-cites="Wooldridge2003">Wooldridge (<a href="../references/references.html#ref-Wooldridge2003" role="doc-biblioref">2003</a>)</span>, <span class="citation" data-cites="Wooldridge2005">Wooldridge (<a href="../references/references.html#ref-Wooldridge2005" role="doc-biblioref">2005</a>)</span> (see all <span class="citation" data-cites="Murtazashvili2008">Murtazashvili and Wooldridge (<a href="../references/references.html#ref-Murtazashvili2008" role="doc-biblioref">2008</a>)</span> for the IV within estimator case).</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>Conditions (<a href="#eq-average_orthogonality_condition" class="quarto-xref"><span>3.7</span></a>) and (<a href="#eq-mean_independence_condition" class="quarto-xref"><span>3.8</span></a>) restrict the dependence structure between <span class="math inline">\(\bbeta_i\)</span> and <span class="math inline">\(\bX_{it}\)</span>. Such conditions are sometimes called correlated random effects (CRE) in the literature. CRE assumptions lie between fixed effects (FE) frameworks — which do not restrict the dependence — and random effects (RE) — which assume that unobserved components are independent of the observed ones.</p>
</div>
</div>
</div>
</section>
<section id="intuition" class="level3" data-number="3.3.3">
<h3 data-number="3.3.3" class="anchored" data-anchor-id="intuition"><span class="header-section-number">3.3.3</span> Intuition</h3>
<p>How can we interpret condition (<a href="#eq-mean_independence_condition" class="quarto-xref"><span>3.8</span></a>)? Intuitively, it requires that the changes in <span class="math inline">\(\bX_{it}\)</span> over time are uncorrelated with the individual coefficients.</p>
<p>To see this interpretation, it is helpful to think of the following example framework. Suppose that <span class="math inline">\(\bX_{it}\)</span> is stationary, that is, its distribution does not depend on <span class="math inline">\(t\)</span>. Decompose <span class="math inline">\(\bX_{it}\)</span> as <span class="math display">\[
\bX_{it} = \E[\bX_{it}|\bbeta_i]  + \bxi_{it},
\]</span></p>
<p>Then the within transformed variables satisfy: <span class="math display">\[
    \tilde{\bX}_{it} = \tilde{\bxi}_{it}.
\]</span></p>
<p>The “systemic” component <span class="math inline">\(\E[\bX_{it}|\bbeta_i]\)</span> is not present in <span class="math inline">\(\tilde{\bX}_{it}\)</span>. Only the deviations across time <span class="math inline">\(\tilde{\bxi}_{it}\)</span> are left. Condition (<a href="#eq-mean_independence_condition" class="quarto-xref"><span>3.8</span></a>) requires that <span class="math inline">\(\tilde{\bxi}_{it}\)</span> and <span class="math inline">\(\bEta_i\)</span> are unrelated on average. At the same time, it permits an arbitrary relationship between <span class="math inline">\(\bbeta_i\)</span> and <span class="math inline">\(\E[\bX_{it}|\bbeta_i]\)</span>.</p>
<p>As an example, suppose that we are working with consumption data. A consumer knows their marginal utilities <span class="math inline">\(\bbeta_i\)</span> of consuming more of a variety of products. With this knowledge, they choose the optimal desired level of consumption — <span class="math inline">\(\E[\bX_{it}|\bbeta_i]\)</span>. When they try to buy this level of products, they may encounter some frictions <span class="math inline">\(\bxi_{it}\)</span> which cause them to deviate from <span class="math inline">\(\E[\bX_{it}|\bbeta_i]\)</span> — in rough words, the supermarket might not have their favorite cereal. If these “frictions” are uncorrelated with <span class="math inline">\(\bbeta_i\)</span>, then the required consistency holds. In the consumption example, this fact means that unpredictable deviation in short-term choices do not necessarily bias the estimation of overall preferences.</p>
</section>
<section id="why-panel-data-is-useful" class="level3" data-number="3.3.4">
<h3 data-number="3.3.4" class="anchored" data-anchor-id="why-panel-data-is-useful"><span class="header-section-number">3.3.4</span> Why Panel Data is Useful</h3>
<p>It is useful to contrast condition (<a href="#eq-mean_independence_condition" class="quarto-xref"><span>3.8</span></a>) with the stronger condition that <span id="eq-linear-within-cross-sectional-mean-indep"><span class="math display">\[
\E[\bEta_i|\bX_i]=0.
\tag{3.9}\]</span></span> Note the difference in the conditioning sets!</p>
<p>Condition (<a href="#eq-linear-within-cross-sectional-mean-indep" class="quarto-xref"><span>3.9</span></a>) is stronger than (<a href="#eq-mean_independence_condition" class="quarto-xref"><span>3.8</span></a>) by the tower property of conditional expectation. Intuitively, we can compute <span class="math inline">\(\tilde{\bX}_i\)</span> from <span class="math inline">\(\bX_i\)</span>, but not vice versa. The requirement that <span class="math inline">\(\E[\bEta_i|\bX_i]=0\)</span> may be very strong, since it would in general require that <span class="math inline">\(\E[\bX_{it}|\bbeta_i]\)</span> does not depend on <span class="math inline">\(\bbeta_i\)</span> — we rule out a systemic dependence even on average.</p>
<p>This contrast also highlights the advantages of panel data. If you want to consistently estimate <span class="math inline">\(\E[\bbeta_i]\)</span> using OLS and cross-sectional data, you need the strong condition (<a href="#eq-linear-within-cross-sectional-mean-indep" class="quarto-xref"><span>3.9</span></a>) or at least that <span class="math inline">\(\E[\bX_i\bX_i'\bbeta_i]=0\)</span>. With panel data, weaker conditions are sufficient, and systemic dependence between <span class="math inline">\(\bbeta_i\)</span> and <span class="math inline">\(\bX_{it}\)</span> is possible.</p>
</section>
<section id="example" class="level3" data-number="3.3.5">
<h3 data-number="3.3.5" class="anchored" data-anchor-id="example"><span class="header-section-number">3.3.5</span> Example</h3>
<p>We conclude this section with a small illustration of the results in a tractable model (see <a href="https://vladislav-morozov.github.io/blog/statistics/heterogeneity/2025-02-01-fixed_effects_danger/">this blog post</a> for a simulation with some dramatic examples). Specifically, we consider the following panel model with two periods, coefficient heterogeneity, and a scalar regressor: <span class="math display">\[
Y_{it} = A_i + \beta_i X_{it} + U_{it}, \quad t=1,2.
\]</span></p>
<p>where <span class="math inline">\(\bX_{it}\)</span> and <span class="math inline">\(\bbeta_i\)</span> are jointly normal:</p>
<p><span id="eq-within_normal_dgp"><span class="math display">\[
\begin{aligned}
    \begin{pmatrix}
      X_{i1}\\
      X_{i2}\\
      \beta_i
    \end{pmatrix} \sim N\left(  \begin{pmatrix}
    1\\
    2\\
    0.5
    \end{pmatrix}, \begin{pmatrix}
    1 &amp; \rho_{1, \beta}\rho_{2, \beta} &amp; \rho_{1, \beta}\\
    \rho_{1, \beta}\rho_{2, \beta} &amp; 1 &amp; \rho_{2, \beta}\\
    \rho_{1, \beta} &amp; \rho_{2, \beta} &amp; 1
    \end{pmatrix}   \right),
\end{aligned}
\tag{3.10}\]</span></span> where the various <span class="math inline">\(\rho\)</span> parameters are correlations. The setting is such that <span class="math inline">\(X_{i1}\)</span> and <span class="math inline">\(X_{i2}\)</span> are only correlated through <span class="math inline">\(\beta_i\)</span>. The distribution of the <span class="math inline">\(A_i\)</span> does not have to be specified, as it is not involved in the consistency conditions. Likewise, we only need to assume that <span class="math inline">\(\E[U_{it}|X_{i1}, X_{i2}]=0\)</span> without further specifying the distribution of <span class="math inline">\(U_{it}\)</span>.</p>
<p>The within transformations yields the following equation: <span class="math display">\[
                Y_{i2} - Y_{i1} = \beta_i(X_{i2}-X_{i1}) + (U_{i2}-U_{i1})
\]</span> The mean independence condition <a href="#eq-mean_independence_condition" class="quarto-xref"><span>3.8</span></a> takes form <span class="math display">\[
    \E[ \beta_i|X_{i2} - X_{i1}]  = 0.5.
\]</span></p>
<p>It is not difficult to work out <span class="citation" data-cites="Brockwell2016IntroductionTimeSeries">(<a href="../references/references.html#ref-Brockwell2016IntroductionTimeSeries" role="doc-biblioref">Brockwell and Davis 2016, A.3.1</a>)</span> that <span class="math display">\[
\E[ \beta_i|X_{i2} - X_{i1}]  = 0.5 + (\rho_{2, \beta}- \rho_{1, \beta})(X_{i2} - X_{i1} - 1)
\]</span> Thus, <span class="math inline">\(\E[ \beta_i|X_{i2} - X_{i1}]=0.5\)</span> only holds if <span id="eq-within-normal-example"><span class="math display">\[
\rho_{2, \beta} = \rho_{1, \beta}.
\tag{3.11}\]</span></span> In this case, <span class="math inline">\(X_{it}\)</span> becomes stationary, and does not have dynamics that depend on <span class="math inline">\(\beta_i\)</span> in the mean.</p>
<p>If condition (<a href="#eq-within-normal-example" class="quarto-xref"><span>3.11</span></a>) holds, the within estimator is consistent for <span class="math inline">\(\E[\beta_i]\)</span>. It is also possible to show that if condition (<a href="#eq-within-normal-example" class="quarto-xref"><span>3.11</span></a>) fails, so does the more general <a href="#eq-average_orthogonality_condition" class="quarto-xref">Equation&nbsp;<span>3.7</span></a>, and the within estimator is inconsistent for <span class="math inline">\(\E[\beta_i]\)</span>. We represent this fact on <a href="#fig-within-normal" class="quarto-xref">Figure&nbsp;<span>3.1</span></a>, where we fix <span class="math inline">\(\rho_{1, beta}=0.25\)</span>, and vary <span class="math inline">\(\rho_{2, \beta}\)</span> between <span class="math inline">\(-1\)</span> and <span class="math inline">\(1\)</span>. Observe that the within estimator is consistent if <span class="math inline">\(\rho_{2, \beta} = \rho_{1, \beta} = 0.25\)</span>. Otherwise, it is biased, potentially severely. For <span class="math inline">\(\rho_{2, \beta}\leq -0.6\)</span>, the estimand of the within estimator has a sign different from that of <span class="math inline">\(\E[\beta_i]\)</span>.</p>
<div id="fig-within-normal" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-within-normal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../figures/ols_heterogeneity.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-within-normal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.1: The within estimator under coefficient heterogeneity. Consistency and inconsistency for the average coefficient under data generating process (<a href="#eq-within_normal_dgp" class="quarto-xref"><span>3.10</span></a>)
</figcaption>
</figure>
</div>
<hr>
<section id="next-section" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="next-section">Next Section</h4>
<p>In the next section, we turn to the dynamic case and briefly introduce the “standard” dynamic panel instrumental variable estimators.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-Brockwell2016IntroductionTimeSeries" class="csl-entry" role="listitem">
Brockwell, Peter J., and Richard A. Davis. 2016. <em>Introduction to <span>Time Series</span> and <span>Forecasting</span></em>. Springer <span>Texts</span> in <span>Statistics</span>. Springer International Publishing.
</div>
<div id="ref-Campello2019" class="csl-entry" role="listitem">
Campello, Murillo, Antonio F. Galvao, and Ted Juhl. 2019. <span>“<span class="nocase">Testing for Slope Heterogeneity Bias in Panel Data Models</span>.”</span> <em>Journal of Business and Economic Statistics</em> 37 (4): 749–60. <a href="https://doi.org/10.1080/07350015.2017.1421545">https://doi.org/10.1080/07350015.2017.1421545</a>.
</div>
<div id="ref-Murtazashvili2008" class="csl-entry" role="listitem">
Murtazashvili, Irina, and Jeffrey M. Wooldridge. 2008. <span>“<span class="nocase">Fixed effects instrumental variables estimation in correlated random coefficient panel data models</span>.”</span> <em>Journal of Econometrics</em> 142 (1): 539–52. <a href="https://doi.org/10.1016/j.jeconom.2007.09.001">https://doi.org/10.1016/j.jeconom.2007.09.001</a>.
</div>
<div id="ref-Wooldridge2003" class="csl-entry" role="listitem">
Wooldridge, Jeffrey M. 2003. <span>“<span class="nocase">Fixed Effects Estimation of the Population-Averaged Slopes in a Panel Data Random Coefficient Model</span>.”</span> <em>Econometric Theory</em> 19: 411–13. <a href="https://doi.org/10+10170S0266466603002081">https://doi.org/10+10170S0266466603002081</a>.
</div>
<div id="ref-Wooldridge2005" class="csl-entry" role="listitem">
———. 2005. <span>“<span class="nocase">Fixed-effects and related estimators for correlated random-coefficient and treatment-effect panel data models</span>.”</span> <em>The Review of Economics and Statistics</em> 87 (May): 385–90.
</div>
</div>
</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/vladislav-morozov\.github\.io\/econometrics-heterogeneity\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../linear/linear-introduction.html" class="pagination-link" aria-label="Intro: Linear Models with Heterogeneous Coefficients">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Intro: Linear Models with Heterogeneous Coefficients</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../linear/linear-dynamic-panel-iv.html" class="pagination-link" aria-label="Interlude: Standard Dynamic Panel Estimators">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Interlude: Standard Dynamic Panel Estimators</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/vladislav-morozov/econometrics-heterogeneity/edit/main/src/linear/linear-within-estimator.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/vladislav-morozov/econometrics-heterogeneity/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>